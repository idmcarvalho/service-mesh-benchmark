---
# Network Policy for gRPC Benchmark Traffic
# Allows gRPC traffic between client and server for benchmarking
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-grpc-benchmark
  namespace: grpc-benchmark
  labels:
    app: grpc-benchmark
    policy: allow-grpc
spec:
  podSelector:
    matchLabels:
      app: grpc-server
  policyTypes:
  - Ingress
  - Egress

  # Allow ingress from grpc-client
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: grpc-client
    ports:
    - protocol: TCP
      port: 50051

  # Allow egress for health checks
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: grpc-server
    ports:
    - protocol: TCP
      port: 50051

  # Allow DNS resolution
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53
---
# Client policy - allow egress to server
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-grpc-client
  namespace: grpc-benchmark
  labels:
    app: grpc-benchmark
    policy: allow-client
spec:
  podSelector:
    matchLabels:
      app: grpc-client
  policyTypes:
  - Egress

  # Allow egress to grpc-server
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: grpc-server
    ports:
    - protocol: TCP
      port: 50051

  # Allow DNS resolution
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53
