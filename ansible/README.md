# Ansible Configuration for Service Mesh Benchmark

This directory contains Ansible playbooks for configuring and deploying the Service Mesh Benchmark application to OCI.

## Quick Start

```bash
# 1. Verify inventory (auto-generated by Terraform)
cat inventory/hosts.yml

# 2. Test connectivity
ansible all -m ping

# 3. Setup server (install Docker, kubectl, etc.)
ansible-playbook playbooks/setup-server.yml

# 4. Deploy application
ansible-playbook playbooks/deploy-app.yml
```

## Playbooks

### setup-server.yml

Configures the OCI instance with required software:
- Docker and Docker Compose
- kubectl for Kubernetes management
- System optimizations (file limits, kernel parameters)
- Python dependencies for Ansible

**Run once** after infrastructure is created.

```bash
ansible-playbook -i inventory/hosts.yml playbooks/setup-server.yml
```

### deploy-app.yml

Deploys and configures the application:
- Clones repository
- Generates environment configuration
- Builds Docker images
- Starts all services (Database, Redis, API, Frontend, Monitoring)
- Performs health checks

**Run for initial deployment and updates**.

```bash
ansible-playbook -i inventory/hosts.yml playbooks/deploy-app.yml
```

**Update application**:
```bash
ansible-playbook -i inventory/hosts.yml playbooks/deploy-app.yml --tags update
```

## Directory Structure

```
ansible/
├── ansible.cfg              # Ansible configuration
├── inventory/
│   ├── .gitkeep
│   └── hosts.yml           # Auto-generated by Terraform
├── playbooks/
│   ├── setup-server.yml    # Server configuration
│   └── deploy-app.yml      # Application deployment
└── templates/
    └── env.production.j2   # Environment file template
```

## Configuration

### Inventory

The inventory file (`inventory/hosts.yml`) is automatically generated by Terraform and includes:
- Instance IP address
- SSH configuration
- Environment variables
- Application paths

### Variables

Variables can be overridden via:
- Inventory file (auto-generated)
- Command line: `ansible-playbook playbook.yml -e "var=value"`
- Group/host vars files

### Secrets

Passwords are prompted during deployment or auto-generated if not provided.

Credentials are saved to `/opt/service-mesh-benchmark/CREDENTIALS.txt` on the instance.

## Common Tasks

### View Application Logs

```bash
ansible benchmark_servers -a "docker-compose -f /opt/service-mesh-benchmark/docker-compose.prod.yml logs -f api"
```

### Restart Services

```bash
ansible benchmark_servers -a "docker-compose -f /opt/service-mesh-benchmark/docker-compose.prod.yml restart"
```

### Check Container Status

```bash
ansible benchmark_servers -a "docker ps"
```

### Backup Database

```bash
ansible benchmark_servers -a "docker exec benchmark-postgres pg_dump -U benchmark service_mesh_benchmark > /tmp/backup.sql"
```

### Update Configuration

1. Edit `.env.production` on instance
2. Restart services:
   ```bash
   ansible-playbook -i inventory/hosts.yml playbooks/deploy-app.yml --tags restart
   ```

## Requirements

### Local Machine

- Ansible >= 2.14
- Python 3.8+
- SSH client

### Remote Instance

Requirements are automatically installed by `setup-server.yml`:
- Ubuntu 22.04
- Python 3
- Docker and Docker Compose
- kubectl

## Troubleshooting

### Connection Issues

```bash
# Test SSH manually
ssh -i ~/.ssh/oci_benchmark_key ubuntu@<PUBLIC_IP>

# Verify inventory
ansible-inventory --list

# Increase verbosity
ansible-playbook playbooks/setup-server.yml -vvv
```

### Docker Issues

```bash
# Check Docker status
ansible benchmark_servers -a "systemctl status docker"

# Restart Docker
ansible benchmark_servers -a "systemctl restart docker" --become
```

### Application Issues

```bash
# View all container logs
ansible benchmark_servers -a "docker-compose -f /opt/service-mesh-benchmark/docker-compose.prod.yml logs"

# Check container health
ansible benchmark_servers -a "docker ps --format 'table {{.Names}}\t{{.Status}}'"
```

## Documentation

See [../docs/TERRAFORM_ANSIBLE_DEPLOYMENT.md](../docs/TERRAFORM_ANSIBLE_DEPLOYMENT.md) for complete documentation.

## Notes

- The inventory file is regenerated on each `terraform apply`
- Playbooks are idempotent - safe to run multiple times
- Use `--check` flag for dry-run: `ansible-playbook playbook.yml --check`
- Use `--tags` to run specific tasks: `ansible-playbook playbook.yml --tags docker`
